{% extends "base.html" %}
{% block content %}

  <h1 class="page-title" style="margin-top:0;">Your Medical Profile</h1>

  <!-- actions -->
  <div style="display:flex; gap:.5rem; margin:.5rem 0 1rem;">
    <button id="editBtn" type="button" class="btn" style="width:auto;">Edit</button>
    <a class="btn btn--muted" style="width:auto;"
       href="{{ url_for('translate.provider_card', lang=LANG) }}">
      Provider Card ({{ LANG|upper }})
    </a>
  </div>

  <!-- read-only view -->
  <div id="output" aria-live="polite"></div>

  <!-- edit form -->
  <form id="textForm" class="form-card" hidden>
    <h2 class="form-title">Edit Details</h2>

    <div class="form-row">
      <label class="form-label" for="userSymptoms">
        Describe your symptoms
      </label>
      <textarea id="userSymptoms" name="userSymptoms" rows="4" class="textarea"
                placeholder="List symptoms, one per line..."></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userMedications">
        List any medications
      </label>
      <textarea id="userMedications" name="userMedications" rows="4" class="textarea"
                placeholder="Drug name, dose, frequency..."></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userConditions">
        Existing medical conditions
      </label>
      <textarea id="userConditions" name="userConditions" rows="4" class="textarea"
                placeholder="Diabetes, asthma, etc."></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userAllergies">
        Allergies (medications/foods)
      </label>
      <textarea id="userAllergies" name="userAllergies" rows="3" class="textarea"
                placeholder="Penicillin, peanuts, etc."></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userSurgeries">
        Past surgeries / procedures
      </label>
      <textarea id="userSurgeries" name="userSurgeries" rows="3" class="textarea"
                placeholder="Appendectomy (2019), ..."></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userVaccines">
        Vaccinations
      </label>
      <textarea id="userVaccines" name="userVaccines" rows="3" class="textarea"
                placeholder="COVID-19 (2023 booster), Tdap (2022), ..."></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userFHistory">
        Family medical history
      </label>
      <textarea id="userFHistory" name="userFHistory" rows="3" class="textarea"
                placeholder="Parent: hypertension; sibling: asthma; ..."></textarea>
    </div>

    <div class="btn-row">
      <button type="submit" class="btn">Save</button>
      <button id="cancelBtn" type="button" class="btn btn--muted">Cancel</button>
    </div>    
  </form>

  <script>
    let lastProfile = null;
    const form = document.getElementById('textForm');
    const output = document.getElementById('output');
    const editBtn = document.getElementById('editBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    const show = el => el.hidden = false;
    const hide = el => el.hidden = true;

    function clearChildren(el){ while (el.firstChild) el.removeChild(el.firstChild); }

    function createListFromText(text) {
      const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const ul = document.createElement('ul');
      (lines.length ? lines : ['(none)']).forEach(t => {
        const li = document.createElement('li'); li.textContent = t; ul.appendChild(li);
      });
      return ul;
    }

    // pretty read-only card sections
    function renderPatientInfo({
      symptoms='', medications='', conditions='', allergies='',
      surgeries='', vaccines='', family_history=''
    } = {}) {
      clearChildren(output);
      const card = document.createElement('div');
      card.className = 'form-card'; // reuse same look as form
      const h = document.createElement('h2');
      h.className = 'form-title';
      h.textContent = 'Patient Info';
      card.appendChild(h);

      const sections = [
        ['Symptoms', symptoms],
        ['Medications', medications],
        ['Conditions', conditions],
        ['Allergies', allergies],
        ['Surgeries', surgeries],
        ['Vaccinations', vaccines],
        ['Family History', family_history],
      ];
      sections.forEach(([label, value])=>{
        const sec = document.createElement('section'); sec.className = 'form-row';
        const title = document.createElement('h3'); title.className = 'section-title'; title.textContent = label;
        sec.appendChild(title);
        sec.appendChild(createListFromText(value));
        card.appendChild(sec);
      });

      output.appendChild(card);
    }

    async function loadProfile() {
      try {
        const res = await fetch('/profile/data', { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        lastProfile = data;

        // prefill
        document.getElementById('userSymptoms').value    = data.symptoms || '';
        document.getElementById('userMedications').value = data.medications || '';
        document.getElementById('userConditions').value  = data.conditions || '';
        document.getElementById('userAllergies').value   = data.allergies || '';
        document.getElementById('userSurgeries').value   = data.surgeries || '';
        document.getElementById('userVaccines').value    = data.vaccines || '';
        document.getElementById('userFHistory').value    = data.family_history || '';

        renderPatientInfo(data);
        hide(form);
        show(output);
      } catch(_) {}
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        symptoms:       document.getElementById('userSymptoms').value,
        medications:    document.getElementById('userMedications').value,
        conditions:     document.getElementById('userConditions').value,
        allergies:      document.getElementById('userAllergies').value,
        surgeries:      document.getElementById('userSurgeries').value,
        vaccines:       document.getElementById('userVaccines').value,
        family_history: document.getElementById('userFHistory').value,
      };
      try {
        const res = await fetch('/profile/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const json = await res.json().catch(()=>null);
        if (!res.ok || !json) throw new Error('Save failed');
        const newState = json.profile || payload;
        lastProfile = newState;
        renderPatientInfo(newState);
        hide(form); show(output);
      } catch (err) {
        alert('Error saving profile.');
      }
    });

    editBtn?.addEventListener('click', () => {
      hide(output); show(form); form.scrollIntoView({behavior:'smooth'});
    });

    cancelBtn?.addEventListener('click', () => {
      if (lastProfile) {
        document.getElementById('userSymptoms').value    = lastProfile.symptoms || '';
        document.getElementById('userMedications').value = lastProfile.medications || '';
        document.getElementById('userConditions').value  = lastProfile.conditions || '';
        document.getElementById('userAllergies').value   = lastProfile.allergies || '';
        document.getElementById('userSurgeries').value   = lastProfile.surgeries || '';
        document.getElementById('userVaccines').value    = lastProfile.vaccines || '';
        document.getElementById('userFHistory').value    = lastProfile.family_history || '';
      }
      hide(form); show(output);
    });

    document.addEventListener('DOMContentLoaded', loadProfile);
  </script>
{% endblock %}
