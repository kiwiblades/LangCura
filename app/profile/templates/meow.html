{% extends "base.html" %}
{% block content %}

  <h1 class="page-title" style="margin-top:0;">LANGCURA</h1>

  <!-- actions -->
  <div style="display:flex; gap:.5rem; margin:.5rem 0 1rem;">
    <button id="editBtn" type="button" class="btn" style="width:auto;">
      {{ t('edit', LANG) }}
    </button>
    <a class="btn btn--muted" style="width:auto;"
       href="{{ url_for('translate.provider_card', lang=LANG) }}">
      {{ t('provider_card', LANG) }} ({{ LANG|upper }})
    </a>
  </div>

  <!-- read-only view -->
  <div id="output" aria-live="polite"></div>

  <!-- edit form -->
  <form id="textForm" class="form-card" hidden>
    <h2 class="form-title">{{ t('edit', LANG) }}</h2>

    <div class="form-row">
      <label class="form-label" for="userSymptoms">
        {{ t('symptoms_edit', LANG) }}
      </label>
      <textarea id="userSymptoms" name="userSymptoms" rows="4" class="textarea"
                placeholder="{{ t('ph_symptoms', LANG) }}"></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userMedications">
        {{ t('medications_edit', LANG) }}
      </label>
      <textarea id="userMedications" name="userMedications" rows="4" class="textarea"
                placeholder="{{ t('ph_meds', LANG) }}"></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userConditions">
        {{ t('conditions_edit', LANG) }}
      </label>
      <textarea id="userConditions" name="userConditions" rows="4" class="textarea"
                placeholder="{{ t('ph_conditions', LANG) }}"></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userAllergies">
        {{ t('allergies_edit', LANG) }}
      </label>
      <textarea id="userAllergies" name="userAllergies" rows="3" class="textarea"
                placeholder="{{ t('ph_allergies', LANG) }}"></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userSurgeries">
        {{ t('surgeries_edit', LANG) }}
      </label>
      <textarea id="userSurgeries" name="userSurgeries" rows="3" class="textarea"
                placeholder="{{ t('ph_surgeries', LANG) }}"></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userVaccines">
        {{ t('vaccines_edit', LANG) }}
      </label>
      <textarea id="userVaccines" name="userVaccines" rows="3" class="textarea"
                placeholder="{{ t('ph_vaccines', LANG) }}"></textarea>
    </div>

    <div class="form-row">
      <label class="form-label" for="userFHistory">
        {{ t('family_edit', LANG) }}
      </label>
      <textarea id="userFHistory" name="userFHistory" rows="3" class="textarea"
                placeholder="{{ t('ph_family', LANG) }}"></textarea>
    </div>

    <div class="btn-row">
      <button type="submit" class="btn">{{ t('submit', LANG) }}</button>
      <button id="cancelBtn" type="button" class="btn btn--muted">{{ t('cancel', LANG) }}</button>
    </div>    
  </form>

  <script>
    // Localized strings
    const L = {
    patient_info: `{{ t('profile_title', LANG) }}`,
    symptoms:     `{{ t('symptoms', LANG) }}`,
    medications:  `{{ t('medications', LANG) }}`,
    conditions:   `{{ t('conditions', LANG) }}`,
    allergies:    `{{ t('allergies', LANG) }}`,
    surgeries:    `{{ t('surgeries', LANG) }}`,
    vaccines:     `{{ t('vaccines', LANG) }}`,
    family:       `{{ t('family_history', LANG) }}`,
    none:         `{{ t('none', LANG) }}`,
    save_error:   `{{ t('save_error', LANG) }}`
  };
    let lastProfile = null;
    const form = document.getElementById('textForm');
    const output = document.getElementById('output');
    const editBtn = document.getElementById('editBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    const show = el => el.hidden = false;
    const hide = el => el.hidden = true;

    function clearChildren(el){ while (el.firstChild) el.removeChild(el.firstChild); }

    function createListFromText(text) {
      const lines = String(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const ul = document.createElement('ul');
      (lines.length ? lines : [L.none]).forEach(t => {
        const li = document.createElement('li'); li.textContent = t; ul.appendChild(li);
      });
      return ul;
    }

    // pretty read-only card sections
    function renderPatientInfo({
      symptoms='', medications='', conditions='', allergies='',
      surgeries='', vaccines='', family_history=''
    } = {}) {
      clearChildren(output);
      const card = document.createElement('div');
      card.className = 'form-card'; // reuse same look as form
      const h = document.createElement('h2');
      h.className = 'form-title';
      h.textContent = L.patient_info;
      card.appendChild(h);

      const sections = [
        [L.symptoms, symptoms],
        [L.medications, medications],
        [L.conditions, conditions],
        [L.allergies, allergies],
        [L.surgeries, surgeries],
        [L.vaccines, vaccines],
        [L.family, family_history],
      ];
      sections.forEach(([label, value])=>{
        const sec = document.createElement('section'); sec.className = 'form-row';
        const title = document.createElement('h3'); title.className = 'section-title'; title.textContent = label;
        sec.appendChild(title);
        sec.appendChild(createListFromText(value));
        card.appendChild(sec);
      });

      output.appendChild(card);
    }

    async function loadProfile() {
      try {
        const res = await fetch('/profile/data', { credentials: 'same-origin' });
        if (!res.ok) return;
        const data = await res.json();
        lastProfile = data;

        // prefill
        document.getElementById('userSymptoms').value    = data.symptoms || '';
        document.getElementById('userMedications').value = data.medications || '';
        document.getElementById('userConditions').value  = data.conditions || '';
        document.getElementById('userAllergies').value   = data.allergies || '';
        document.getElementById('userSurgeries').value   = data.surgeries || '';
        document.getElementById('userVaccines').value    = data.vaccines || '';
        document.getElementById('userFHistory').value    = data.family_history || '';

        renderPatientInfo(data);
        hide(form);
        show(output);
      } catch(_) {}
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        symptoms:       document.getElementById('userSymptoms').value,
        medications:    document.getElementById('userMedications').value,
        conditions:     document.getElementById('userConditions').value,
        allergies:      document.getElementById('userAllergies').value,
        surgeries:      document.getElementById('userSurgeries').value,
        vaccines:       document.getElementById('userVaccines').value,
        family_history: document.getElementById('userFHistory').value,
      };
      try {
        const res = await fetch('/profile/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        const json = await res.json().catch(()=>null);
        if (!res.ok || !json) throw new Error('Save failed');
        const newState = json.profile || payload;
        lastProfile = newState;
        renderPatientInfo(newState);
        hide(form); show(output);
      } catch (err) {
        alert(L.save_error);
      }
    });

    editBtn?.addEventListener('click', () => {
      hide(output); show(form); form.scrollIntoView({behavior:'smooth'});
    });

    cancelBtn?.addEventListener('click', () => {
      if (lastProfile) {
        document.getElementById('userSymptoms').value    = lastProfile.symptoms || '';
        document.getElementById('userMedications').value = lastProfile.medications || '';
        document.getElementById('userConditions').value  = lastProfile.conditions || '';
        document.getElementById('userAllergies').value   = lastProfile.allergies || '';
        document.getElementById('userSurgeries').value   = lastProfile.surgeries || '';
        document.getElementById('userVaccines').value    = lastProfile.vaccines || '';
        document.getElementById('userFHistory').value    = lastProfile.family_history || '';
      }
      hide(form); show(output);
    });

    document.addEventListener('DOMContentLoaded', loadProfile);
  </script>
{% endblock %}